---
title: Validation Tests (API)
description: 3 tests for request validation via the Layers API
---

# Validation Tests (API)

Validation tests verify that the Layers API correctly validates incoming requests and returns appropriate error messages.

## Test Summary

| Test | Description |
|------|-------------|
| Missing Model | Returns 400 when model is missing |
| Invalid Model | Returns 400 for unknown model |
| Missing Messages | Returns 400 when messages empty |

## Running Tests

```bash
cd packages/@layers/models
LAYERS_API_URL=https://web-nine-sage-13.vercel.app \
LAYERS_API_KEY=lyr_live_xxx \
bun test layers-api -t "Validation"
```

## Test Implementation

### Missing Model Test

```typescript
it('should reject request without model', async () => {
  const response = await fetch(`${LAYERS_API_URL}/api/v1/chat`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${LAYERS_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      messages: [
        { role: 'user', content: 'Hello' }
      ],
      max_tokens: 10,
    }),
  });

  expect(response.status).toBe(400);
  const data = await response.json();
  expect(data.error.code).toBe('invalid_request');
  expect(data.error.message).toContain('model');
});
```

### Invalid Model Test

```typescript
it('should reject unknown model', async () => {
  const response = await fetch(`${LAYERS_API_URL}/api/v1/chat`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${LAYERS_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'invalid/nonexistent-model',
      messages: [
        { role: 'user', content: 'Hello' }
      ],
      max_tokens: 10,
    }),
  });

  expect(response.status).toBe(400);
  const data = await response.json();
  expect(data.error.code).toBe('invalid_model');
});
```

### Missing Messages Test

```typescript
it('should reject request without messages', async () => {
  const response = await fetch(`${LAYERS_API_URL}/api/v1/chat`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${LAYERS_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'anthropic/claude-haiku-4.5',
      messages: [],
      max_tokens: 10,
    }),
  });

  expect(response.status).toBe(400);
  const data = await response.json();
  expect(data.error.code).toBe('invalid_request');
  expect(data.error.message).toContain('messages');
});
```

## Validation Rules

| Field | Rule | Error |
|-------|------|-------|
| `model` | Required, must be valid | `invalid_request` or `invalid_model` |
| `messages` | Required, non-empty array | `invalid_request` |
| `messages[].role` | Must be `system`, `user`, or `assistant` | `invalid_request` |
| `messages[].content` | Required, non-empty | `invalid_request` |
| `max_tokens` | Optional, positive integer | `invalid_request` |
| `temperature` | Optional, 0-2 | `invalid_request` |

## Error Response Format

```json
{
  "error": {
    "code": "invalid_request",
    "message": "The 'model' field is required",
    "type": "invalid_request_error",
    "param": "model"
  }
}
```

## Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `invalid_request` | 400 | Malformed request body |
| `invalid_model` | 400 | Model not found |
| `invalid_api_key` | 401 | Authentication failed |
| `insufficient_credits` | 402 | Not enough balance |
| `rate_limit_exceeded` | 429 | Too many requests |
| `server_error` | 500 | Internal error |

## Valid Request Example

```json
{
  "model": "anthropic/claude-haiku-4.5",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": "Hello!"
    }
  ],
  "max_tokens": 100,
  "temperature": 0.7
}
```

## Common Validation Errors

### Missing Required Fields

```json
// Bad: Missing model
{
  "messages": [{ "role": "user", "content": "Hi" }]
}

// Error Response
{
  "error": {
    "code": "invalid_request",
    "message": "The 'model' field is required",
    "param": "model"
  }
}
```

### Invalid Model ID

```json
// Bad: Invalid model format
{
  "model": "gpt-4",  // Should be "openai/gpt-4o"
  "messages": [{ "role": "user", "content": "Hi" }]
}

// Error Response
{
  "error": {
    "code": "invalid_model",
    "message": "Model 'gpt-4' not found. Use format: provider/model-name"
  }
}
```

### Invalid Message Role

```json
// Bad: Unknown role
{
  "model": "anthropic/claude-haiku-4.5",
  "messages": [
    { "role": "customer", "content": "Hi" }  // Invalid role
  ]
}

// Error Response
{
  "error": {
    "code": "invalid_request",
    "message": "Invalid message role 'customer'. Must be 'system', 'user', or 'assistant'",
    "param": "messages[0].role"
  }
}
```

### Invalid Parameter Values

```json
// Bad: Temperature out of range
{
  "model": "anthropic/claude-haiku-4.5",
  "messages": [{ "role": "user", "content": "Hi" }],
  "temperature": 5  // Must be 0-2
}

// Error Response
{
  "error": {
    "code": "invalid_request",
    "message": "Temperature must be between 0 and 2",
    "param": "temperature"
  }
}
```

## Client-Side Validation

```typescript
function validateRequest(request: ChatRequest): ValidationResult {
  const errors: string[] = [];

  if (!request.model) {
    errors.push('model is required');
  }

  if (!request.messages || request.messages.length === 0) {
    errors.push('messages is required and must not be empty');
  }

  if (request.temperature !== undefined) {
    if (request.temperature < 0 || request.temperature > 2) {
      errors.push('temperature must be between 0 and 2');
    }
  }

  if (request.max_tokens !== undefined) {
    if (request.max_tokens < 1) {
      errors.push('max_tokens must be positive');
    }
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}
```

## Best Practices

1. **Validate client-side** - Catch errors before sending
2. **Check model format** - Always use `provider/model-name`
3. **Handle all error codes** - Different codes need different handling
4. **Log validation errors** - Help debug integration issues
5. **Use TypeScript** - Type safety catches many errors
