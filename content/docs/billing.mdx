---
title: Billing & Credits
description: Complete guide to Layers billing - credits, margins, Stripe integration, and pricing sync
---

# Billing & Credits

This document covers everything about how Layers billing works: the credit system, cost calculations, margins, Stripe subscriptions, and pricing synchronization.

---

## Credit System Overview

Layers uses a unified credit system that abstracts away the complexity of different AI provider pricing models into a single balance.

### Core Concept

**1 credit = $0.01 USD worth of AI usage (before margin)**

When you use any AI model through Layers:
1. We calculate the raw cost based on tokens used
2. Apply a margin (default 60%)
3. Deduct credits from your balance

This means the actual cost per credit to you is **~$0.016** (accounting for the 60% margin).

---

## Cost Calculation

### The Formula

```
credits = (base_cost_usd / $0.01) × (1 + margin_percent / 100)
```

With the default 60% margin:

```
credits = (base_cost_usd / $0.01) × 1.60
```

### Example Calculation

Using Claude Sonnet 4.5 with 1,000 input tokens and 500 output tokens:

| Component | Calculation | Value |
|-----------|-------------|-------|
| **Input Cost** | 1,000 tokens × $3.00/1M | $0.003 |
| **Output Cost** | 500 tokens × $15.00/1M | $0.0075 |
| **Base Cost** | $0.003 + $0.0075 | $0.0105 |
| **Credits (before margin)** | $0.0105 / $0.01 | 1.05 |
| **Margin (60%)** | 1.05 × 0.60 | 0.63 |
| **Total Credits** | 1.05 + 0.63 | **1.68 credits** |

### Per-Model Pricing Reference

All prices are per **1,000 tokens** from Vercel AI Gateway:

| Model | Provider | Input USD | Output USD | Credits (60% margin) |
|-------|----------|-----------|------------|---------------------|
| GPT-4o Mini | OpenAI | $0.0001 | $0.0006 | ~0.01 |
| Gemini 2.5 Flash Lite | Google | $0.0001 | $0.0004 | ~0.01 |
| Gemini 2.5 Flash | Google | $0.0003 | $0.0025 | ~0.05 |
| Claude 4.5 Haiku | Anthropic | $0.001 | $0.005 | ~0.10 |
| Claude 4.5 Sonnet | Anthropic | $0.003 | $0.015 | ~0.29 |
| GPT-4o | OpenAI | $0.0025 | $0.01 | ~0.20 |
| Claude 4.5 Opus | Anthropic | $0.005 | $0.025 | ~0.48 |

---

## Margin System

### What is Margin?

The margin is the markup Layers applies on top of the base AI provider costs. This covers:
- Infrastructure and API hosting
- Credit management and billing
- Rate limiting and security
- Support and maintenance

### Default Margin: 60%

The default margin is 60%, meaning:
- **Your cost**: 160% of provider cost
- **Layers revenue**: 60% of provider cost

### Margin Breakdown in API Response

Every API response includes a full cost breakdown:

```json
{
  "layers": {
    "credits_used": 1.68,
    "cost_breakdown": {
      "base_cost_usd": 0.0105,
      "margin_percent": 60,
      "total_cost_usd": 0.0168,
      "credits_before_margin": 1.05,
      "margin_credits": 0.63,
      "validation": "ok"
    }
  }
}
```

### Credit-to-Cost Ratio Quick Reference

| Base Cost (USD) | Credits @ 60% margin |
|-----------------|---------------------|
| $0.001 | 0.16 credits |
| $0.005 | 0.80 credits |
| $0.01 | 1.60 credits |
| $0.05 | 8.00 credits |
| $0.10 | 16.00 credits |

### Custom Margin Configuration

Margins can be configured per-deployment (contact us for enterprise pricing):

```typescript
// Example margin configuration
const marginConfig = {
  defaultMarginPercent: 60,
  modelOverrides: {
    'anthropic/claude-opus-4.5': 80,    // Higher for expensive models
    'openai/gpt-4o-mini': 40,           // Lower for budget models
  }
};
```

---

## Subscription Tiers

### Tier Comparison

| Tier | Monthly Price | Credits Included | Rate Limit | Overage Rate |
|------|---------------|------------------|------------|--------------|
| **Free** | $0 | 50 | 10/min | N/A |
| **Starter** | $20/mo | 500 | 60/min | $0.05/credit |
| **Pro** | $100/mo | 3,000 | 300/min | $0.04/credit |
| **Team** | $200/mo | 7,500 | 1,000/min | $0.033/credit |

### What Can You Do With Credits?

| Credits | Approximate Usage |
|---------|-------------------|
| 50 (Free) | ~15 Claude Haiku conversations |
| 500 (Starter) | ~100 GPT-4o queries or ~160 Gemini Flash |
| 3,000 (Pro) | ~600 Claude Sonnet or ~1,000 GPT-4o |
| 7,500 (Team) | ~1,500 Claude Sonnet or ~2,500 GPT-4o |

### Credit Renewal

Credits are renewed on your billing cycle:
- **Monthly subscriptions**: Credits added on subscription renewal date
- **Unused credits**: Roll over (up to 2x your monthly allocation)
- **Overage**: Billed at tier rate at end of billing period

---

## Stripe Integration

Layers uses Stripe for all subscription management and billing.

### Subscription Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Dashboard │ ──▶ │   Stripe    │ ──▶ │   Webhook   │
│   Checkout  │     │   Checkout  │     │   Handler   │
└─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                          ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │   Payment   │     │   Update    │
                    │   Complete  │     │   Credits   │
                    └─────────────┘     └─────────────┘
```

### Webhook Events Handled

| Event | Action |
|-------|--------|
| `checkout.session.completed` | Create subscription, link customer |
| `customer.subscription.created` | Grant initial credits |
| `customer.subscription.updated` | Update tier (upgrade/downgrade) |
| `customer.subscription.deleted` | Revert to free tier |
| `invoice.paid` | Add monthly credits |

### API Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/stripe/checkout` | POST | Create checkout session |
| `/api/stripe/portal` | POST | Access billing portal |
| `/api/stripe/sync` | POST | Sync subscription status |
| `/api/webhooks/stripe` | POST | Handle Stripe webhooks |

### Database Schema

```sql
-- credit_balances table
CREATE TABLE credit_balances (
  id UUID PRIMARY KEY,
  user_id UUID UNIQUE REFERENCES auth.users(id),
  balance DECIMAL(10,2) DEFAULT 0,
  tier TEXT DEFAULT 'free',
  monthly_credits INTEGER DEFAULT 0,
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  subscription_status TEXT,
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

---

## Pricing Sync from Hustle Together AI

Layers automatically syncs pricing data from Hustle Together AI to ensure costs match Vercel AI Gateway rates.

### How It Works

```
┌─────────────────────┐     ┌─────────────────────┐
│   Hustle Together   │     │       Layers        │
│         AI          │     │                     │
│   /api/pricing      │ ◀── │   Fetch pricing     │
│                     │     │   (24hr cache)      │
└─────────────────────┘     └─────────────────────┘
```

1. **On first request** (or when cache expires), Layers fetches pricing from:
   ```
   https://ai.hustletogether.com/api/pricing
   ```

2. **Response cached for 24 hours** to minimize API calls

3. **Fallback**: If sync fails, hardcoded pricing is used as fallback

### Pricing API Response Format

```json
{
  "version": "2026-01-23T12:00:00Z",
  "source": "vercel-ai-gateway",
  "models": {
    "anthropic/claude-sonnet-4.5": { "input": 0.003, "output": 0.015 },
    "openai/gpt-4o": { "input": 0.0025, "output": 0.01 },
    "google/gemini-2.5-flash": { "input": 0.0003, "output": 0.0025 }
  }
}
```

### Pricing Priority

1. **Synced pricing** from Hustle Together AI (preferred)
2. **Fallback pricing** hardcoded in Layers (backup)

### Pricing Dashboard

View and manage pricing at `/dashboard/pricing`:
- Sync status and cache age
- Adjustable margin percentage
- All models with USD cost and credit conversion
- Real-time credit calculations

### API Endpoint

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/pricing` | GET | View current pricing and sync status |
| `/api/v1/pricing` | POST | Force refresh from Hustle Together AI |

---

## Credit Deduction Flow

When an API request is made:

```
┌─────────────────────────────────────────────────────────────┐
│                       REQUEST FLOW                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. PRE-FLIGHT ESTIMATE                                     │
│     └─▶ estimateCredits(model, max_tokens)                 │
│         └─▶ Check user balance >= estimate                  │
│         └─▶ Return 402 if insufficient                      │
│                                                             │
│  2. AI GATEWAY CALL                                         │
│     └─▶ Call Vercel AI Gateway                             │
│         └─▶ Get actual token usage                          │
│                                                             │
│  3. ACTUAL CALCULATION                                      │
│     └─▶ calculateCreditsWithBreakdown(                     │
│             model, input_tokens, output_tokens              │
│         )                                                   │
│         └─▶ Returns { credits, breakdown }                  │
│                                                             │
│  4. DEDUCTION & LOGGING                                     │
│     └─▶ deductCredits(userId, credits)                     │
│     └─▶ logUsage(userId, model, tokens, credits)           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Code Example

```typescript
// Pre-flight check
const estimated = estimateCredits(model, max_tokens);
if (user.balance < estimated) {
  return { error: 'Insufficient credits', status: 402 };
}

// Make AI call
const result = await callGateway(request);

// Calculate actual credits
const { credits, breakdown } = calculateCreditsWithBreakdown(
  model,
  result.usage.prompt_tokens,
  result.usage.completion_tokens
);

// Deduct and log
await Promise.all([
  deductCredits(userId, credits),
  logUsage({
    user_id: userId,
    model_id: model,
    input_tokens: result.usage.prompt_tokens,
    output_tokens: result.usage.completion_tokens,
    credits_used: credits,
    cost_breakdown: breakdown,
  }),
]);
```

---

## External Cost Validation (Mirror Factory)

Layers supports external cost input for validation purposes.

### How It Works

If you calculate your own base costs (e.g., from Mirror Factory), you can pass them to Layers:

```json
{
  "model": "anthropic/claude-sonnet-4.5",
  "messages": [...],
  "mirror_factory": {
    "base_cost_usd": 0.0105
  }
}
```

Layers will:
1. **Use your cost** for billing
2. **Validate** against its own calculation
3. **Flag discrepancies** > 5% as warnings

### Validation Response

```json
{
  "layers": {
    "cost_breakdown": {
      "base_cost_usd": 0.0105,
      "validation": "ok"
    }
  }
}
```

Or if there's a discrepancy:

```json
{
  "layers": {
    "cost_breakdown": {
      "validation": "warning",
      "validation_details": {
        "external_base_cost_usd": 0.0105,
        "calculated_base_cost_usd": 0.0100,
        "difference_usd": 0.0005,
        "difference_percent": 5.0
      }
    }
  }
}
```

---

## Environment Variables

### Required for Billing

| Variable | Description |
|----------|-------------|
| `STRIPE_SECRET_KEY` | Stripe API secret key |
| `STRIPE_WEBHOOK_SECRET` | Webhook signing secret |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Stripe public key |
| `STRIPE_STARTER_PRICE_ID` | Stripe price ID for Starter tier |
| `STRIPE_PRO_PRICE_ID` | Stripe price ID for Pro tier |
| `STRIPE_TEAM_PRICE_ID` | Stripe price ID for Team tier |

### Optional

| Variable | Description | Default |
|----------|-------------|---------|
| `HUSTLE_TOGETHER_PRICING_API_URL` | Pricing sync source | `https://ai.hustletogether.com/api/pricing` |

---

## SDK Functions

### Credit Calculation

```typescript
import { calculateCredits, estimateCredits, creditsToUsd } from '@/lib/middleware/credits';

// Calculate actual credits
const credits = calculateCredits(model, inputTokens, outputTokens);

// Pre-flight estimate
const estimated = estimateCredits(model, maxTokens);

// Convert credits to USD
const usd = creditsToUsd(credits);  // credits × $0.00625
```

### Credit Breakdown

```typescript
import { calculateCreditsWithBreakdown } from '@/lib/middleware/credits';

const { credits, breakdown } = calculateCreditsWithBreakdown(
  'anthropic/claude-sonnet-4.5',
  1000,  // input tokens
  500,   // output tokens
  { base_cost_usd: 0.0105 }  // optional external cost
);

console.log(breakdown);
// {
//   base_cost_usd: 0.0105,
//   margin_percent: 60,
//   total_cost_usd: 0.0168,
//   credits_before_margin: 1.05,
//   margin_credits: 0.63,
//   validation: "ok"
// }
```

---

## Next Steps

- [Architecture](/docs/architecture) - How the full system works
- [API Reference](/docs/api/reference) - Full endpoint documentation
- [Model Selection](/docs/models) - Choose the right model
