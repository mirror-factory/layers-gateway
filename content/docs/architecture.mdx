---
title: Architecture
description: How the Layers API works - request flow, middleware, and deployment
---

# Architecture

This document explains how the Layers API processes requests, from your application to the AI provider and back.

## Request Flow

```
                              YOUR APPLICATION
                                    │
                                    │ POST /api/v1/chat/completions
                                    │ Authorization: Bearer lyr_live_xxx
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            LAYERS API                                    │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 1. AUTH MIDDLEWARE                                                │   │
│  │    • Validate API key format (lyr_live_* or lyr_test_*)          │   │
│  │    • Look up key in database                                      │   │
│  │    • Return 401 if invalid/expired/revoked                       │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 2. RATE LIMIT MIDDLEWARE                                          │   │
│  │    • Check requests/minute by subscription tier                   │   │
│  │    • Free: 10/min, Starter: 60/min, Pro: 300/min, Team: 1000/min │   │
│  │    • Return 429 if exceeded                                       │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 3. CREDIT MIDDLEWARE                                              │   │
│  │    • Estimate cost based on model + max_tokens                   │   │
│  │    • Check user balance                                           │   │
│  │    • Return 402 if insufficient credits                          │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 4. GATEWAY CLIENT                                                 │   │
│  │    • Call Vercel AI Gateway with our service key                 │   │
│  │    • Use AI SDK: generateText({ model: gateway('provider/model')})│   │
│  │    • Handle streaming if enabled                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 5. POST-PROCESSING                                                │   │
│  │    • Calculate actual credits used based on token counts         │   │
│  │    • Deduct from user balance                                    │   │
│  │    • Log usage for analytics                                      │   │
│  │    • Return OpenAI-compatible response format                    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ AI SDK createGateway()
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        VERCEL AI GATEWAY                                 │
│                                                                          │
│  • Routes requests based on model prefix:                               │
│    - anthropic/* → Anthropic API                                        │
│    - openai/* → OpenAI API                                              │
│    - google/* → Google AI API                                           │
│    - perplexity/* → Perplexity API                                      │
│    - morph/* → Morph API                                                │
│  • Manages API keys for each provider                                   │
│  • Provides unified response format                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                            AI PROVIDERS
                    (Anthropic, OpenAI, Google, etc.)
```

## Project Structure

```
layers-dev/
├── app/
│   ├── api/v1/              # Core API endpoints
│   │   ├── chat/            # Chat completions
│   │   └── image/           # Image generation
│   ├── dashboard/           # User dashboard
│   └── docs/                # Documentation (Fumadocs)
├── lib/
│   ├── models/              # Model registry (24 models)
│   ├── credits/             # Credit calculation
│   ├── gateway/             # AI SDK wrapper
│   ├── middleware/          # Auth, rate limit, credits
│   └── supabase/            # Database client
├── content/docs/            # MDX documentation
└── __tests__/               # Test files
```

## Key Components

| File | Purpose |
|------|---------|
| `app/api/v1/chat/route.ts` | Main chat endpoint (OpenAI-compatible) |
| `app/api/v1/chat/completions/route.ts` | Alias for SDK compatibility |
| `lib/middleware/auth.ts` | API key validation, user lookup |
| `lib/middleware/credits.ts` | Credit calculation, deduction |
| `lib/middleware/rate-limit.ts` | Per-tier rate limiting |
| `lib/gateway/client.ts` | Vercel AI SDK wrapper |
| `lib/models/registry.ts` | Model definitions with pricing |
| `lib/credits/calculator.ts` | Credit calculation logic |

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `AI_GATEWAY_API_KEY` | Yes | Vercel AI Gateway key |
| `NEXT_PUBLIC_SUPABASE_URL` | Yes | Supabase project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Yes | Supabase anon key |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Supabase service key |
| `STRIPE_SECRET_KEY` | Yes | Stripe API key |
| `STRIPE_WEBHOOK_SECRET` | Yes | Stripe webhook secret |

## Database Schema

### api_keys

```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  key_hash TEXT NOT NULL UNIQUE,  -- SHA-256 hash
  key_prefix TEXT NOT NULL,       -- First 8 chars for identification
  name TEXT,
  is_active BOOLEAN DEFAULT true,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  last_used_at TIMESTAMPTZ
);
```

### credit_balances

```sql
CREATE TABLE credit_balances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  balance DECIMAL(10,2) DEFAULT 0,
  tier TEXT DEFAULT 'free',
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### usage_logs

```sql
CREATE TABLE usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  model_id TEXT NOT NULL,
  input_tokens INTEGER,
  output_tokens INTEGER,
  credits_used DECIMAL(10,4),
  latency_ms INTEGER,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

## URLs

| Service | URL |
|---------|-----|
| **Layers API** | https://layers.hustletogether.com |
| **Dashboard** | https://layers.hustletogether.com/dashboard |
| **Documentation** | https://layers.hustletogether.com/docs |

## Security Considerations

1. **API keys are hashed** - We store SHA-256 hashes, not raw keys
2. **Server-side only** - Never expose API keys to browsers
3. **Rate limiting** - Prevents abuse and runaway costs
4. **Credit limits** - Users can only spend their balance
5. **Cloudflare protection** - Zero Trust on sensitive routes

## OpenAI SDK Compatibility

Layers is fully compatible with the OpenAI SDK and Vercel AI SDK:

```typescript
import { createOpenAI } from '@ai-sdk/openai';

const layers = createOpenAI({
  apiKey: process.env.LAYERS_API_KEY,
  baseURL: 'https://layers.hustletogether.com/api/v1',
});

const result = await generateText({
  model: layers('anthropic/claude-sonnet-4-20250514'),
  prompt: 'Hello!',
});
```

## Next Steps

- [Authentication](/docs/authentication) - API key management
- [API Reference](/docs/api/reference) - Full endpoint documentation
- [Credit System](/docs/credits) - Pricing and usage
