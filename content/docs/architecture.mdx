---
title: Architecture
description: How the Layers API works - request flow, middleware, and deployment modes
---

# Architecture

This document explains how the Layers API processes requests, from your application to the AI provider and back.

## Request Flow

```
                              YOUR APPLICATION
                                    │
                                    │ POST /api/v1/chat
                                    │ Authorization: Bearer lyr_live_xxx
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            LAYERS API                                    │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 1. AUTH MIDDLEWARE                                                │   │
│  │    • Validate API key format (lyr_live_* or lyr_test_*)          │   │
│  │    • Look up key in database (or return mock user in demo mode)  │   │
│  │    • Return 401 if invalid/expired/revoked                       │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 2. RATE LIMIT MIDDLEWARE                                          │   │
│  │    • Check requests/minute by subscription tier                   │   │
│  │    • Free: 10/min, Starter: 60/min, Pro: 300/min, Team: 1000/min │   │
│  │    • Return 429 if exceeded                                       │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 3. CREDIT MIDDLEWARE                                              │   │
│  │    • Estimate cost based on model + max_tokens                   │   │
│  │    • Check user balance                                           │   │
│  │    • Return 402 if insufficient credits                          │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 4. GATEWAY CLIENT                                                 │   │
│  │    • Call Vercel AI Gateway with our service key                 │   │
│  │    • Use AI SDK: generateText({ model: gateway('provider/model')})│   │
│  │    • Handle streaming if enabled                                  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │ 5. POST-PROCESSING                                                │   │
│  │    • Calculate actual credits used based on token counts         │   │
│  │    • Deduct from user balance                                    │   │
│  │    • Log usage for analytics                                      │   │
│  │    • Return OpenAI-compatible response format                    │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ AI SDK createGateway()
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        VERCEL AI GATEWAY                                 │
│                                                                          │
│  • Routes requests based on model prefix:                               │
│    - anthropic/* → Anthropic API                                        │
│    - openai/* → OpenAI API                                              │
│    - google/* → Google AI API                                           │
│    - perplexity/* → Perplexity API                                      │
│    - morph/* → Morph API                                                │
│  • Manages API keys for each provider                                   │
│  • Provides unified response format                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                            AI PROVIDERS
                    (Anthropic, OpenAI, Google, etc.)
```

## Deployment Modes

### Demo Mode (Current)

When Supabase is **not configured**, the API runs in demo mode:

| Feature | Behavior |
|---------|----------|
| API Key Validation | Format check only (`lyr_live_*`) |
| User Lookup | Returns mock user: `{userId: 'demo-user', tier: 'free', balance: 100}` |
| Rate Limiting | **Works** (10 req/min demo tier) |
| Credit Checking | **Works** (against mock balance) |
| Credit Deduction | **Skipped** (no database) |
| Usage Logging | **Skipped** (no database) |

**Demo mode is useful for:**
- Testing the API without setting up Supabase
- Verifying the playground works
- Development and debugging

### Production Mode

When Supabase is **configured**, the API runs in production mode:

| Feature | Behavior |
|---------|----------|
| API Key Validation | Full validation + database lookup |
| User Lookup | Real user from `api_keys` table |
| Rate Limiting | Per-tier limits enforced |
| Credit Checking | Real balance from `credit_balances` |
| Credit Deduction | Actual credits deducted after request |
| Usage Logging | Full logging to `usage_logs` table |

**To enable production mode:**

```env
# Add to apps/web/.env.local
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## Key Components

### apps/web (Layers API)

The main API application that handles all requests:

| File | Purpose |
|------|---------|
| `app/api/v1/chat/route.ts` | Main endpoint (GET health, POST chat) |
| `lib/middleware/auth.ts` | API key validation, user lookup |
| `lib/middleware/credits.ts` | Credit calculation, deduction |
| `lib/middleware/rate-limit.ts` | Per-tier rate limiting |
| `lib/gateway/client.ts` | Vercel AI SDK wrapper |
| `lib/supabase/client.ts` | Database client, key hashing |

### apps/playground

Interactive UI for testing the API:

| File | Purpose |
|------|---------|
| `app/page.tsx` | Main playground interface |
| `app/api/chat/route.ts` | Proxy to Layers API |
| `lib/models.ts` | Re-exports from @layers/models registry |
| `components/model-selector.tsx` | Model dropdown with capabilities |

### packages/@layers/models

TypeScript model registry (source of truth):

| File | Purpose |
|------|---------|
| `src/registry.ts` | 23 models with full metadata |
| `src/types.ts` | TypeScript type definitions |
| `src/helpers.ts` | Query and filter functions |

## Environment Variables

### apps/web (API)

| Variable | Required | Description |
|----------|----------|-------------|
| `AI_GATEWAY_API_KEY` | Yes | Vercel AI Gateway key (`vck_...`) |
| `SUPABASE_URL` | No | Enables production mode |
| `SUPABASE_SERVICE_KEY` | No | Required with SUPABASE_URL |

### apps/playground

| Variable | Required | Description |
|----------|----------|-------------|
| `LAYERS_API_URL` | Yes | URL of the Layers API |
| `LAYERS_API_KEY` | Yes | A valid `lyr_live_*` key |

## Database Schema (Production)

When Supabase is configured, these tables are used:

### api_keys

```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  key_hash TEXT NOT NULL UNIQUE,  -- SHA-256 hash
  key_prefix TEXT NOT NULL,       -- First 8 chars for identification
  name TEXT,
  is_active BOOLEAN DEFAULT true,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  last_used_at TIMESTAMPTZ
);
```

### credit_balances

```sql
CREATE TABLE credit_balances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  balance DECIMAL(10,2) DEFAULT 0,
  tier TEXT DEFAULT 'free',
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

### usage_logs

```sql
CREATE TABLE usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  model_id TEXT NOT NULL,
  input_tokens INTEGER,
  output_tokens INTEGER,
  credits_used DECIMAL(10,4),
  latency_ms INTEGER,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

## Current Deployments

| Application | URL | Purpose |
|-------------|-----|---------|
| **Layers API** | https://web-nine-sage-13.vercel.app | Main API endpoint |
| **Playground** | https://playground-ten-woad.vercel.app | Interactive testing |
| **Documentation** | https://docs-wheat-mu.vercel.app | This documentation |

## Using a Custom Domain

To use a custom domain (e.g., `api.layers.dev`):

1. Add custom domain in Vercel dashboard for the "web" project
2. Configure DNS records (Cloudflare or your DNS provider)
3. Update playground's `LAYERS_API_URL` environment variable
4. Redeploy the playground

No code changes required - it's purely URL configuration.

## Security Considerations

1. **API keys are hashed** - We store SHA-256 hashes, not raw keys
2. **Server-side only** - Never expose API keys to browsers
3. **Rate limiting** - Prevents abuse and runaway costs
4. **Credit limits** - Users can only spend their balance
5. **Demo mode isolation** - No real billing in development

## Next Steps

- [Authentication](/docs/authentication) - API key management
- [API Reference](/docs/api/reference) - Full endpoint documentation
- [Credit System](/docs/credits) - Pricing and usage
