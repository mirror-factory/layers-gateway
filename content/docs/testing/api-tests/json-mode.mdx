---
title: JSON Mode Tests (API)
description: 2 tests for structured output via the Layers API
---

# JSON Mode Tests (API)

JSON mode tests verify that the Layers API correctly handles requests for structured JSON output.

## Test Summary

| Test | Model | Description |
|------|-------|-------------|
| Claude JSON | claude-sonnet-4.5 | Return structured JSON |
| GPT-4o JSON | gpt-4o | Return structured JSON |

## Running Tests

```bash
cd packages/@layers/models
LAYERS_API_URL=https://layers.hustletogether.com \
LAYERS_API_KEY=lyr_live_xxx \
bun test layers-api -t "JSON"
```

## Test Implementation

### Claude JSON Mode Test

```typescript
it('should return JSON with Claude via API', async () => {
  const response = await fetch(`${LAYERS_API_URL}/api/v1/chat`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${LAYERS_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'anthropic/claude-sonnet-4.5',
      messages: [
        {
          role: 'user',
          content: 'Return a JSON object with name and age fields for John who is 30.',
        },
      ],
      response_format: { type: 'json_object' },
      max_tokens: 100,
    }),
  });

  expect(response.status).toBe(200);
  const data = await response.json();

  const parsed = JSON.parse(data.choices[0].message.content);
  expect(parsed.name).toBe('John');
  expect(parsed.age).toBe(30);
});
```

### GPT-4o JSON Mode Test

```typescript
it('should return JSON with GPT-4o via API', async () => {
  const response = await fetch(`${LAYERS_API_URL}/api/v1/chat`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${LAYERS_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'openai/gpt-4o',
      messages: [
        { role: 'system', content: 'Return valid JSON only.' },
        {
          role: 'user',
          content: 'Return a JSON object with name and age fields for John who is 30.',
        },
      ],
      response_format: { type: 'json_object' },
      max_tokens: 100,
    }),
  });

  expect(response.status).toBe(200);
  const data = await response.json();

  const parsed = JSON.parse(data.choices[0].message.content);
  expect(parsed.name).toBe('John');
  expect(parsed.age).toBe(30);
});
```

## Request Format

```json
{
  "model": "anthropic/claude-sonnet-4.5",
  "messages": [
    {
      "role": "user",
      "content": "Return a JSON object with product details."
    }
  ],
  "response_format": { "type": "json_object" },
  "max_tokens": 200
}
```

## Response Format Options

| Option | Description |
|--------|-------------|
| `{ "type": "text" }` | Normal text output (default) |
| `{ "type": "json_object" }` | Forces valid JSON output |

## Response

```json
{
  "id": "chatcmpl-xxx",
  "model": "anthropic/claude-sonnet-4.5",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "{\"name\":\"John\",\"age\":30}"
      },
      "finish_reason": "stop"
    }
  ]
}
```

## JSON Schema (OpenAI)

For GPT models, you can specify a schema:

```json
{
  "model": "openai/gpt-4o",
  "messages": [
    { "role": "user", "content": "Generate a user profile." }
  ],
  "response_format": {
    "type": "json_schema",
    "json_schema": {
      "name": "user_profile",
      "schema": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "age": { "type": "integer" },
          "email": { "type": "string", "format": "email" }
        },
        "required": ["name", "age"]
      }
    }
  }
}
```

## Supported Models

| Model | JSON Mode | JSON Schema |
|-------|-----------|-------------|
| anthropic/claude-* | Yes | No |
| openai/gpt-4o | Yes | Yes |
| openai/gpt-4o-mini | Yes | Yes |
| google/gemini-* | Yes | Limited |
| perplexity/sonar | Limited | No |
| morph/morph-* | No | No |

## Usage Example

```typescript
const response = await fetch('https://api.layers.dev/v1/chat', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer lyr_live_xxx',
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    model: 'anthropic/claude-sonnet-4.5',
    messages: [
      {
        role: 'user',
        content: `Extract the following information as JSON:
          - name
          - company
          - role

          From: "Hi, I'm Sarah from Acme Corp. I'm the CTO."`,
      },
    ],
    response_format: { type: 'json_object' },
    max_tokens: 100,
  }),
});

const data = await response.json();
const extracted = JSON.parse(data.choices[0].message.content);
// { name: "Sarah", company: "Acme Corp", role: "CTO" }
```

## Best Practices

1. **Include "JSON" in prompt** - Reinforces the expected format
2. **Provide examples** - Show the exact structure you want
3. **Always parse** - Validate the JSON response
4. **Handle errors** - Models may occasionally return invalid JSON

```typescript
try {
  const parsed = JSON.parse(data.choices[0].message.content);
  // Use parsed data
} catch (error) {
  console.error('Invalid JSON:', data.choices[0].message.content);
  // Handle gracefully
}
```

## Complex Structures

```json
{
  "model": "anthropic/claude-sonnet-4.5",
  "messages": [
    {
      "role": "user",
      "content": "Analyze this text and return: { \"sentiment\": \"positive|negative|neutral\", \"topics\": [\"topic1\", \"topic2\"], \"summary\": \"...\" }"
    }
  ],
  "response_format": { "type": "json_object" }
}
```
