---
title: Helper Function Tests
description: 48 unit tests for model helper functions
---

# Helper Function Tests

The `helpers.test.ts` file contains 48 unit tests for core helper functions used throughout the Layers platform.

## Test Summary

| Category | Tests | Description |
|----------|-------|-------------|
| Cost Calculation | 15 | Calculate costs based on token usage |
| Model Metadata | 10 | Retrieve model information |
| Validation | 8 | Validate model names and formats |
| Response Formatting | 10 | Format AI responses |
| Request Parsing | 5 | Parse incoming requests |
| **Total** | **48** | |

## Running Tests

```bash
cd packages/@layers/models
bun test helpers.test.ts
```

## Cost Calculation (15 tests)

Tests for `calculateCost()` and `calculateCredits()` functions.

### Tests

| Test | Description |
|------|-------------|
| `should calculate cost for Anthropic models` | Verifies Claude pricing |
| `should calculate cost for OpenAI models` | Verifies GPT pricing |
| `should calculate cost for Google models` | Verifies Gemini pricing |
| `should calculate cost for Perplexity models` | Verifies Sonar pricing |
| `should calculate cost for Morph models` | Verifies Morph pricing |
| `should handle zero tokens` | Returns 0 for no usage |
| `should handle large token counts` | Handles millions of tokens |
| `should apply input/output pricing correctly` | Different rates for in/out |
| `should convert cost to credits` | USD to credit conversion |
| `should estimate credits for max_tokens` | Pre-flight estimation |
| `should handle unknown models gracefully` | Falls back to default pricing |
| `should calculate thinking token costs` | Extended thinking pricing |
| `should calculate cache hit pricing` | Reduced cost for cached prompts |
| `should calculate cache write pricing` | Additional cost for cache writes |
| `should handle mixed usage scenarios` | Complex pricing scenarios |

### Example

```typescript
import { calculateCost, calculateCredits } from '@layers/models';

// Calculate cost in USD
const cost = calculateCost({
  model: 'anthropic/claude-sonnet-4.5',
  inputTokens: 5000,
  outputTokens: 1000,
});
// Returns: 0.021 (USD)

// Convert to credits
const credits = calculateCredits('anthropic/claude-sonnet-4.5', 5000, 1000);
// Returns: 21 (credits = USD * 1000)
```

## Model Metadata (10 tests)

Tests for `getModelMetadata()` and related functions.

### Tests

| Test | Description |
|------|-------------|
| `should return metadata for valid model` | Full model info |
| `should return pricing information` | Input/output rates |
| `should return capabilities` | vision, tools, thinking flags |
| `should return context window size` | Token limits |
| `should return provider information` | Anthropic, OpenAI, etc. |
| `should handle model aliases` | gpt-4o -> openai/gpt-4o |
| `should return null for unknown model` | Graceful failure |
| `should include deprecation status` | Deprecated models flagged |
| `should return image generation models` | Flux, Imagen metadata |
| `should return multimodal capabilities` | Models that output images |

### Example

```typescript
import { getModelMetadata } from '@layers/models';

const metadata = getModelMetadata('anthropic/claude-sonnet-4.5');
// Returns:
// {
//   id: 'anthropic/claude-sonnet-4.5',
//   name: 'Claude Sonnet 4.5',
//   provider: 'anthropic',
//   capabilities: { vision: true, tools: true, thinking: true },
//   pricing: { input: 0.003, output: 0.015 },
//   contextWindow: 200000,
// }
```

## Validation (8 tests)

Tests for `validateModel()` and input validation functions.

### Tests

| Test | Description |
|------|-------------|
| `should validate correct model format` | provider/model-name |
| `should reject invalid format` | Missing provider prefix |
| `should validate known providers` | anthropic, openai, google, etc. |
| `should reject unknown providers` | Invalid provider names |
| `should validate model exists` | Model in registry |
| `should handle case sensitivity` | Model names are case-sensitive |
| `should validate image models` | bfl/flux-*, google/imagen-* |
| `should reject deprecated models` | Optional strict mode |

### Example

```typescript
import { validateModel } from '@layers/models';

validateModel('anthropic/claude-sonnet-4.5'); // Returns: true
validateModel('invalid-model');               // Returns: false
validateModel('unknown/model');               // Returns: false
```

## Response Formatting (10 tests)

Tests for `formatResponse()` and output normalization.

### Tests

| Test | Description |
|------|-------------|
| `should format Anthropic response` | Convert to OpenAI format |
| `should format OpenAI response` | Pass through with normalization |
| `should format Google response` | Convert Gemini format |
| `should format streaming chunks` | SSE format conversion |
| `should include usage stats` | Token counts in response |
| `should handle tool calls` | Format function call results |
| `should handle thinking blocks` | Include reasoning in response |
| `should format error responses` | Consistent error structure |
| `should preserve message content` | No data loss |
| `should add Layers metadata` | credits_used, latency_ms |

### Example

```typescript
import { formatResponse } from '@layers/models';

const formatted = formatResponse({
  provider: 'anthropic',
  rawResponse: anthropicResponse,
  model: 'anthropic/claude-sonnet-4.5',
  latencyMs: 1234,
  creditsUsed: 21,
});
// Returns OpenAI-compatible response with Layers extensions
```

## Request Parsing (5 tests)

Tests for `parseRequest()` and input normalization.

### Tests

| Test | Description |
|------|-------------|
| `should parse OpenAI format` | Standard chat completion |
| `should normalize message roles` | user, assistant, system |
| `should parse tool definitions` | Function schemas |
| `should handle multimodal content` | Image + text messages |
| `should extract provider options` | anthropic, openai, google fields |

### Example

```typescript
import { parseRequest } from '@layers/models';

const parsed = parseRequest({
  model: 'anthropic/claude-sonnet-4.5',
  messages: [{ role: 'user', content: 'Hello' }],
  temperature: 0.7,
  anthropic: { thinking: { type: 'enabled', budget_tokens: 10000 } },
});
// Returns normalized request with provider-specific options extracted
```

## Source Code

View the full test file:
[helpers.test.ts](https://github.com/CrazySwami/layers-dev/blob/main/packages/@layers/models/__tests__/unit/helpers.test.ts)
